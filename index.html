const STORY_ALGO_CONFIG = {
  popularityWeight: 0.55,
  recencyWeight: 0.25,
  noveltyWeight: 0.15,
  randomWeight: 0.05,
  freshDaysBoost: 21,
  freshBoostMultiplier: 1.3,
  explorationFraction: 0.25,
  cardsPerViewport: 6
};

// ----------------- Seeded RNG (one instance per page) -----------------
(function initStorySeed() {
  if (window.__STORY_RENDER_SEED && window.__STORY_RNG) return;
  const time = Date.now() & 0xffffffff;
  let extra = 0;
  if (typeof crypto !== 'undefined' && typeof crypto.getRandomValues === 'function') {
    const arr = new Uint32Array(1);
    crypto.getRandomValues(arr); // actually fill
    extra = arr[0];
  } else {
    extra = Math.floor(Math.random() * 0xffffffff);
  }
  window.__STORY_RENDER_SEED = (time ^ extra) >>> 0;
  // create a single RNG instance for the page and store it
  window.__STORY_RNG = (function mulberry32(seed) {
    let t = seed >>> 0;
    return function() {
      t += 0x6D2B79F5;
      let r = Math.imul(t ^ (t >>> 15), 1 | t);
      r = r + Math.imul(r ^ (r >>> 7), 61 | r) ^ r;
      return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    };
  })(window.__STORY_RENDER_SEED);
})();

function rngForStoryRender() {
  // return the single RNG instance (do not create a new one each call)
  return window.__STORY_RNG || Math.random;
}

// ----------------- Utilities -----------------
function daysSince(dateString) {
  if (!dateString) return Number.MAX_SAFE_INTEGER; // consistent sentinel for missing/invalid
  const d = new Date(dateString);
  if (isNaN(d)) return Number.MAX_SAFE_INTEGER;
  return Math.floor((Date.now() - d.getTime()) / (24 * 60 * 60 * 1000));
}

function normalizeArray(arr) {
  const clean = arr.map(v => Number.isFinite(v) ? v : 0);
  const min = Math.min(...clean);
  const max = Math.max(...clean);
  if (max === min) return clean.map(() => 0.5);
  return clean.map(v => (v - min) / (max - min));
}

function computeStoryPopularity(s) {
  // smoother: log1p(reads) + likes * factor
  const reads = Number(s.reads ?? s.readCount ?? 0);
  const likes = Number(s.likes ?? 0);
  return Math.log1p(reads) + likes * 1.2; // 1.2 is tunable
}

function shuffleArray(arr, rng) {
  // rng should be a function returning [0,1). default to Math.random
  const rand = (typeof rng === 'function') ? rng : Math.random;
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ----------------- Scoring & Exploration -----------------
function scoredStories(stories, rng) {
  rng = (typeof rng === 'function') ? rng : rngForStoryRender();
  const popArr = stories.map(s => computeStoryPopularity(s));
  const ageArr = stories.map(s => {
    const ds = daysSince(s.published || s.createdAt || s.date || s.uploadedAt);
    // recency: 1..365 mapped to 0..365 (recent -> higher)
    return Math.max(0, 365 - Math.min(ds, 365));
  });

  const popNorm = normalizeArray(popArr);
  const recNorm = normalizeArray(ageArr);

  return stories.map((s, i) => {
    const pop = popNorm[i], rec = recNorm[i], novelty = 1 - pop;
    const randomEps = rng() * STORY_ALGO_CONFIG.randomWeight;
    let base = STORY_ALGO_CONFIG.popularityWeight * pop
             + STORY_ALGO_CONFIG.recencyWeight * rec
             + STORY_ALGO_CONFIG.noveltyWeight * novelty
             + randomEps;

    const ageDays = daysSince(s.published || s.createdAt || s.date || s.uploadedAt);
    if (isFinite(ageDays) && ageDays <= STORY_ALGO_CONFIG.freshDaysBoost) base *= STORY_ALGO_CONFIG.freshBoostMultiplier;

    return Object.assign({}, s, { __score: base, __popNorm: pop, __recNorm: rec, __ageDays: ageDays });
  });
}

function pickStoryExploration(candidates, count, rng) {
  if (!candidates || candidates.length === 0 || count <= 0) return [];
  rng = (typeof rng === 'function') ? rng : rngForStoryRender();
  const scored = candidates.map(s => {
    const novelty = 1 - (s.__popNorm ?? 0);
    const recency = s.__recNorm ?? 0;
    const score = (novelty * 0.6) + (recency * 0.4) + rng() * 0.1;
    return Object.assign({}, s, { __exploreScore: score });
  });
  scored.sort((a, b) => b.__exploreScore - a.__exploreScore);
  return shuffleArray(scored.slice(0, Math.min(count, scored.length)), rng);
}

// ----------------- Demo stories generator -----------------
function generateDemoStories(count = 50, rng) {
  rng = (typeof rng === 'function') ? rng : rngForStoryRender();
  const genres = ["Action", "Romance", "Comedy", "Fantasy", "Horror", "Tragic", "Other"];
  const covers = [
    "https://picsum.photos/seed/demo1/600/900",
    "https://picsum.photos/seed/demo2/600/900",
    "https://picsum.photos/seed/demo3/600/900",
    "https://picsum.photos/seed/demo4/600/900",
    "https://picsum.photos/seed/demo5/600/900",
    "https://picsum.photos/seed/demo6/600/900"
  ];
  const stories = [];
  for (let i = 0; i < count; i++) {
    const genre = genres[Math.floor(rng() * genres.length)];
    const title = `${genre} Demo Story ${i + 1}`;
    const readCount = Math.floor(rng() * 1000);
    const likes = Math.floor(rng() * 400);
    const daysAgo = Math.floor(rng() * 400);
    const date = new Date(Date.now() - daysAgo * 86400000).toISOString();
    stories.push({
      id: `demo-${i + 1}`,
      title,
      genre,
      description: `Demo ${genre.toLowerCase()} story â€” random readCount ${readCount}.`,
      cover: covers[i % covers.length],
      readCount,
      reads: readCount,
      likes,
      createdAt: date
    });
  }
  return stories;
}
