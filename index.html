function openSerialPreview(title) {
  try {
    const VOTES_STORE_KEY = 'global_votes_v1';
    const USER_VOTES_KEY = 'user_votes_v1';
    const READS_KEY = 'serial_reads_v1';

    let saved = [];
    try { saved = typeof loadSavedSerials === 'function' ? loadSavedSerials() : (JSON.parse(localStorage.getItem('saved_serials_v1')||'[]')); } catch(e) { saved = []; }
    const serial = (saved || []).find(s => s.title === title) || (serialsData || []).find(s => s.title === title);
    if (!serial) { alert('Serial not found'); return; }

    const voteKey = `serial::${serial.title || 'untitled'}`;
    const readKey = `serial::${serial.title || 'untitled'}`;

    function loadStore(key) { try { return JSON.parse(localStorage.getItem(key) || '{}'); } catch(e) { return {}; } }
    function saveStore(key, obj) { try { localStorage.setItem(key, JSON.stringify(obj || {})); } catch(e) {} }

    const votesStore = loadStore(VOTES_STORE_KEY);
    const userStore = loadStore(USER_VOTES_KEY);
    const readsStore = loadStore(READS_KEY);

    const storedVotes = votesStore[voteKey] || { likes: Number(serial.likes || 0), dislikes: Number(serial.dislikes || 0) };
    serial.likes = Number(storedVotes.likes || 0);
    serial.dislikes = Number(storedVotes.dislikes || 0);
    votesStore[voteKey] = { likes: serial.likes, dislikes: serial.dislikes };
    saveStore(VOTES_STORE_KEY, votesStore);

    const storedReads = readsStore[readKey] || { total: 0, episodes: {} };
    readsStore[readKey] = storedReads;
    saveStore(READS_KEY, readsStore);

    let panel = document.getElementById('serialPreviewFull');
    if (!panel) {
      panel = document.createElement('div');
      panel.id = 'serialPreviewFull';
      panel.className = 'fullscreen-panel';
      panel.style.zIndex = 1100;
      panel.style.overflow = 'auto';
      document.body.appendChild(panel);
    }

    panel.innerHTML = '';
    const inner = document.createElement('div');
    inner.className = 'panel-inner';

    function esc(str) { return String(str == null ? '' : str).replace(/</g,'&lt;'); }
    function formatDateVal(raw) {
      if (!raw && raw !== 0) return '‚Äî';
      let d = null;
      if (typeof raw === 'number' || /^\d+$/.test(String(raw))) { d = new Date(Number(raw)); }
      else { d = new Date(raw); }
      if (isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    let author = serial.author || serial.authorName || serial.writtenBy || serial.writer || serial.by || 'Unknown';
    let rawPublished = serial.publishedOn || serial.date || serial.published || serial.published_on || serial.publishedDate || serial.published_at || new Date().toISOString();
    serial.publishedOn = rawPublished;
    const dateStr = formatDateVal(rawPublished);

    // HEADER
    const header = document.createElement('div');
    header.className = 'panel-top';
    header.innerHTML = `
      <div style="flex:1">
        <h1 style="margin:6px 0 4px 0">${esc(serial.title || 'Untitled')}</h1>
        <div class="panel-meta" style="margin-top:6px">Written by ${esc(author)} ‚Ä¢ Written on ${dateStr}</div>
        <div style="font-size:14px;color:var(--muted);margin-top:6px; display:flex; align-items:center; gap:10px">
          Genre: <span>${esc(serial.genre || '‚Äî')}</span>
        </div>
        <div class="panel-meta" style="margin-top:6px">${esc(serial.description || '')}</div>
      </div>
    `;

    inner.appendChild(header);

    // Add Share button beside Genre
    const genreDiv = header.querySelector('div[style*="display:flex"]');
    if (genreDiv) {
      const shareBtn = document.createElement('button');
      shareBtn.className = 'jelly-btn';
      shareBtn.textContent = 'Share';
      genreDiv.appendChild(shareBtn);

      // Share menu
      const shareMenu = document.createElement('div');
      shareMenu.style.position = 'absolute';
      shareMenu.style.background = 'white';
      shareMenu.style.border = '1px solid #ccc';
      shareMenu.style.padding = '6px';
      shareMenu.style.borderRadius = '6px';
      shareMenu.style.display = 'none';
      shareMenu.style.flexDirection = 'column';
      shareMenu.style.gap = '6px';
      shareMenu.style.minWidth = '180px';
      shareMenu.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
      shareMenu.style.zIndex = 1200;
      document.body.appendChild(shareMenu);

      function getShareText(platform) {
        const link = `https://meurbal.in?serial=${encodeURIComponent(serial.title)}`;
        const message = `Title: ${serial.title || 'Untitled'}\nGenre: ${serial.genre || '‚Äî'}\nDescription: ${serial.description || ''}\nRead here: ${link}`;
        if (platform === 'WhatsApp') return `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
        if (platform === 'Facebook') return `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
        if (platform === 'Instagram') return null;
        return '#';
      }

      ['WhatsApp', 'Instagram', 'Facebook'].forEach(platform => {
        const option = document.createElement('button');
        option.className = 'btn btn-secondary';
        option.textContent = platform;
        option.style.width = '100%';
        option.addEventListener('click', () => {
          const url = getShareText(platform);
          if (url) window.open(url, '_blank');
          else alert('Instagram sharing works only via mobile app.');
          shareMenu.style.display = 'none';
        });
        shareMenu.appendChild(option);
      });

      shareBtn.addEventListener('click', (e) => {
        const rect = shareBtn.getBoundingClientRect();
        shareMenu.style.top = (rect.bottom + window.scrollY + 4) + 'px';
        shareMenu.style.left = (rect.left + window.scrollX) + 'px';
        shareMenu.style.display = shareMenu.style.display === 'flex' ? 'none' : 'flex';
      });

      document.addEventListener('click', (e) => {
        if (!shareMenu.contains(e.target) && e.target !== shareBtn) shareMenu.style.display = 'none';
      });
    }

    // CONTROL WRAPPER (close + likes/dislikes + reads)
    const controlWrapper = document.createElement('div');
    controlWrapper.style.display = 'flex';
    controlWrapper.style.alignItems = 'center';
    controlWrapper.style.gap = '12px';
    controlWrapper.style.margin = '12px 0';

    const closeBtn = document.createElement('button');
    closeBtn.className = 'jelly-btn';
    closeBtn.id = 'closeSerialPreviewBtn';
    closeBtn.textContent = 'Close';
    controlWrapper.appendChild(closeBtn);

    const likeBtn = document.createElement('button');
    likeBtn.className = 'jelly-btn';
    likeBtn.innerHTML = 'üëç <span class="cnt">0</span>';
    likeBtn.dataset.state = 'none';
    controlWrapper.appendChild(likeBtn);

    const dislikeBtn = document.createElement('button');
    dislikeBtn.className = 'jelly-btn dislike-btn';
    dislikeBtn.innerHTML = 'üëé <span class="cnt">0</span>';
    dislikeBtn.dataset.state = 'none';
    controlWrapper.appendChild(dislikeBtn);

    const countDisplay = document.createElement('span');
    countDisplay.style.fontSize = '14px';
    countDisplay.style.color = 'var(--muted)';
    countDisplay.style.minWidth = '160px';
    countDisplay.textContent = `Likes = ${serial.likes}   Dislikes = ${serial.dislikes}`;
    controlWrapper.appendChild(countDisplay);

    const readsDisplay = document.createElement('span');
    readsDisplay.id = 'readCountDisplay';
    readsDisplay.style.fontSize = '14px';
    readsDisplay.style.color = 'var(--muted)';
    readsDisplay.style.minWidth = '120px';
    readsDisplay.textContent = `Reads = ${(readsStore[readKey] && readsStore[readKey].total) ? readsStore[readKey].total : 0}`;
    controlWrapper.appendChild(readsDisplay);

    inner.appendChild(controlWrapper);

    function persistAll() {
      const votes = loadStore(VOTES_STORE_KEY);
      votes[voteKey] = { likes: Number(serial.likes||0), dislikes: Number(serial.dislikes||0) };
      saveStore(VOTES_STORE_KEY, votes);
      try { if (typeof saveSerials === 'function') saveSerials(); } catch(e) {}
    }

    function refreshUI() {
      serial.likes = Math.max(0, Number(serial.likes || 0));
      serial.dislikes = Math.max(0, Number(serial.dislikes || 0));
      const likeCnt = likeBtn.querySelector('.cnt');
      const dislikeCnt = dislikeBtn.querySelector('.cnt');
      if (likeCnt) likeCnt.textContent = serial.likes;
      if (dislikeCnt) dislikeCnt.textContent = serial.dislikes;
      countDisplay.textContent = `Likes = ${serial.likes}   Dislikes = ${serial.dislikes}`;
      const userChoice = (loadStore(USER_VOTES_KEY)[voteKey]) || 'none';
      likeBtn.dataset.state = (userChoice === 'liked') ? 'liked' : 'none';
      dislikeBtn.dataset.state = (userChoice === 'disliked') ? 'disliked' : 'none';
      likeBtn.style.backgroundColor = likeBtn.dataset.state === 'liked' ? '#dbeafe' : '';
      dislikeBtn.style.backgroundColor = dislikeBtn.dataset.state === 'disliked' ? '#fee2e2' : '';
      const readsNow = (loadStore(READS_KEY)[readKey] || { total: 0 }).total;
      const rDisplay = document.getElementById('readCountDisplay');
      if (rDisplay) rDisplay.textContent = `Reads = ${readsNow}`;
    }

    function incrementReadCount(epIndex) {
      const reads = loadStore(READS_KEY);
      reads[readKey] = reads[readKey] || { total: 0, episodes: {} };
      reads[readKey].total++;
      reads[readKey].episodes[epIndex] = (reads[readKey].episodes[epIndex] || 0) + 1;
      saveStore(READS_KEY, reads);
      refreshUI();
    }

    function updateUserVote(newChoice) {
      const votes = loadStore(VOTES_STORE_KEY);
      const user = loadStore(USER_VOTES_KEY);
      votes[voteKey] = votes[voteKey] || { likes: 0, dislikes: 0 };
      const prev = user[voteKey] || 'none';

      if (prev === 'liked') votes[voteKey].likes = Math.max(0, (votes[voteKey].likes||1) - 1);
      if (prev === 'disliked') votes[voteKey].dislikes = Math.max(0, (votes[voteKey].dislikes||1) - 1);

      if (newChoice === 'liked') votes[voteKey].likes = (votes[voteKey].likes||0) + 1;
      if (newChoice === 'disliked') votes[voteKey].dislikes = (votes[voteKey].dislikes||0) + 1;

      user[voteKey] = (newChoice === 'none') ? 'none' : newChoice;

      saveStore(VOTES_STORE_KEY, votes);
      saveStore(USER_VOTES_KEY, user);

      serial.likes = votes[voteKey].likes;
      serial.dislikes = votes[voteKey].dislikes;
      refreshUI();
      try { if (typeof saveSerials === 'function') saveSerials(); } catch(e) {}
    }

    likeBtn.addEventListener('click', function () {
      const current = likeBtn.dataset.state === 'liked' ? 'liked' : (dislikeBtn.dataset.state === 'disliked' ? 'disliked' : 'none');
      if (current === 'liked') updateUserVote('none');
      else updateUserVote('liked');
    });

    dislikeBtn.addEventListener('click', function () {
      const current = dislikeBtn.dataset.state === 'disliked' ? 'disliked' : (likeBtn.dataset.state === 'liked' ? 'liked' : 'none');
      if (current === 'disliked') updateUserVote('none');
      else updateUserVote('disliked');
    });

    const epsWrap = document.createElement('div');
    epsWrap.style.display = 'flex';
    epsWrap.style.flexDirection = 'column';
    epsWrap.style.gap = '10px';

    (serial.episodes || []).forEach((ep, i) => {
      const epCard = document.createElement('div');
      epCard.className = 'story-card';
      epCard.style.display = 'flex';
      epCard.style.justifyContent = 'space-between';
      epCard.style.alignItems = 'center';
      epCard.innerHTML = `
        <div style="max-width:72%">
          <strong>${i+1}. ${(ep.title||('Episode '+(i+1))).replace(/</g,'&lt;')}</strong>
          <div style="font-size:13px;color:var(--muted)">${(ep.description || '').replace(/</g,'&lt;')}</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary read-episode-btn">Read Episode</button>
        </div>
      `;
      epCard.querySelector('.read-episode-btn').addEventListener('click', ()=> {
        incrementReadCount(i);
        openSerialReader(serial.title, i);
      });
      epsWrap.appendChild(epCard);
    });

    inner.appendChild(epsWrap);
    panel.appendChild(inner);

    closeBtn.addEventListener('click', ()=> panel.remove());

    refreshUI();
    window.scrollTo(0,0);

  } catch (err) {
    console.error('openSerialPreview error', err);
    alert('Something went wrong opening preview ‚Äî check console for details.');
  }
}
